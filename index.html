<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading, Auto Facial Detection and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>

    <!-- https://github.com/jaysalvat/jquery.facedetection JavaScript -->
    <script src="jquery.facedetection.min.js"></script>  
    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        
        @media only screen and (min-width: 500px) { 
            canvas {
                width: 400px;
                height: auto;
            }

            #gettingstarted {
                width: 500px;
                height: auto;
            }
        }


        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <div class="sticky-top">
        <button class="btn btn-primary" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary" id="btnFlip" disabled>Flip selfie</button>

        <button class="btn btn-primary" id="btnClearrect" disabled>Clear</button>
        <button class="btn btn-primary" id="btnReady" disabled>Ready</button>
        <button class="btn btn-primary" id="btnAuto" disabled>Automatic</button>
        <button class="btn btn-primary" id="btnCrop" disabled>Crop</button>
        <button class="btn btn-primary" id="btnSave" disabled>Save photo</button>
        <button class="btn btn-secondary" id="btnLeft" disabled>Left</button>
        <button class="btn btn-secondary" id="btnRight" disabled>Right</button>
        <button class="btn btn-secondary" id="btnUp" disabled>Up</button>
        <button class="btn btn-secondary" id="btnDown" disabled>Down</button>
        <button class="btn btn-secondary" id="btnBig" disabled>Bigger</button>
        <button class="btn btn-secondary" id="btnSmall" disabled>Smaller</button>
    </div>
    
    <p id="hints" class="mb-1 lead">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC Eg T1234567Z" aria-label="Name eg anything" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>


    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>


</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
    <script type="text/javascript">$(document).ready(function(){var e=320,t=240,a=$("#hints"),i=$("#alert1"),o=$("#alert2"),n=$("#fileTocrop"),r=$("#fileTosave"),d=$("#labelTosave"),s=$("#btnRotate"),l=$("#btnFlip"),h=$("#btnReady"),c=$("#btnAuto"),p=$("#btnClearrect"),m=$("#btnCrop"),g=$("#btnSave"),f=$("#btnLeft"),v=$("#btnRight"),b=$("#btnUp"),u=$("#btnDown"),w=$("#btnBig"),k=$("#btnSmall"),C=$("#myCanvas"),y=C[0],I=y.getContext("2d"),A=$("#myCanvasTop")[0],x=A.getContext("2d");x.globalAlpha=.2;var R,M=$("#myCropcanvas"),D=M[0],L=D.getContext("2d"),T=$("#myTempcanvas")[0],S=T.getContext("2d"),j=($("#picture"),$("#col2")),P=$("#col3"),U=$("#col4"),X=!1,Y=1,O=!1,B=/ipad|iphone|ipod/i.test(navigator.userAgent.toLowerCase()),E=/msie|trident|edge/i.test(navigator.userAgent.toLowerCase()),F=/crios/i.test(navigator.userAgent.toLowerCase()),z=/webkit/i.test(navigator.userAgent.toLowerCase()),J=["Rotate/Flip photo if necessary.  Click 'Ready' to start cropping","Click 'Automatic' to generate the rectangle","Click on ‘Clear’ to start again.  Click ‘Crop’ if you are satisfied with it.  Click Left/ Right/ Up/ Down/ Bigger/ Smaller to adjust the rectangle","Type in the filename to save as and click ‘Save photo’","Select a photo from your device to crop","Only Safari browser is supported on iPhones/iPads.  Your browser is not supported!","Only Chrome browser is supported on Desktop computers/Laptops.  Your browser is not supported!"];B&&z&&F?a.html("<div class='alert alert-danger' role='alert'>"+J[5]+"</div>"):E?a.html("<div class='alert alert-danger' role='alert'>"+J[6]+"</div>"):a.text(J[4]);var W,Z;W=y.getBoundingClientRect(),Z=window.devicePixelRatio,y.width=Math.round(Z*W.right)-Math.round(Z*W.left),y.height=Math.round(Z*W.bottom)-Math.round(Z*W.top),I.scale(Z,Z),r.hide(),d.hide(),C.hide(),s.hide(),l.hide(),h.hide(),c.hide(),p.hide(),m.hide(),g.hide(),f.hide(),v.hide(),b.hide(),u.hide(),w.hide(),k.hide();var q,G,H=new Image;n.on("change",function(e){a.text(J[0]),i.hide(),o.hide();var t=new FileReader;t.onload=function(e){H.onload=function(){q=H.width,G=H.height,q>G?q>480&&(G*=480/q,q=480):G>640&&(q*=640/G,G=640),A.width=y.width=q,A.height=y.height=G,I.drawImage(H,0,0,q,G),Y=Math.round(5/480*q)},H.src=e.target.result},t.readAsDataURL(e.target.files[0]),C.fadeIn(),j.addClass("col-12"),s.removeAttr("disabled").fadeIn(),l.removeAttr("disabled").fadeIn(),h.removeAttr("disabled").fadeIn(),n.hide(),!0,X=!0});var K=1,N=!1;s.on("click",function(e){a.text(J[0]),N=!0,_(),K++,N=!1,!0});var Q=1,V=!1;l.on("click",function(e){a.text(J[0]),V=!0,_(),Q++,V=!1,!0});var _=function(){I.clearRect(0,0,y.width,y.height);var e=N?K:K-1;e%2==0?(A.width=y.width=q,A.height=y.height=G):(A.width=y.width=G,A.height=y.height=q),I.save(),e%2==0?I.translate(q/2,G/2):I.translate(G/2,q/2),I.rotate(90*e*Math.PI/180),I.translate(-q/2,-G/2),(V?Q:Q-1)%2==0||(e%2==0?(I.translate(q,0),I.scale(-1,1)):(I.translate(0,G),I.scale(1,-1))),I.drawImage(H,0,0,q,G),I.restore()},ee="";$(window).on("scroll",function(e){ee=a.html(),!O&&X&&p.trigger("click"),a.html(ee)}),$(window).on("resize",function(e){ee=a.html(),!O&&X&&p.trigger("click"),a.html(ee)});var te,ae,ie,oe,ne=!1;function re(i){a.text(J[2]),C.faceDetection({complete:function(a){console.log(a),1!=a.length?ne=!0:(te=a[0].x-((a[0].offsetX+a[0].width)*a[0].scaleX-a[0].x)/3,ae=(a[0].offsetX+a[0].width)*a[0].scaleX+((a[0].offsetX+a[0].width)*a[0].scaleX-a[0].x)/5,te<0&&(te=0),ae>240&&(ae=240),(ie=a[0].y-(a[0].offsetY+a[0].height)*a[0].scaleY/4)<0&&(ie=0),oe=ie+e*(ae-te)/t,ve(te,ie,!1),ve(ae,oe,!0),be(),ue())},error:function(e,t){ne=!0}}),ne&&(ae=190,oe=240,ve(te=70,ie=80,!1),ve(ae,oe,!0),be(),ue()),!1,s.hide(),l.hide(),h.hide(),f.removeAttr("disabled").fadeIn(),v.removeAttr("disabled").fadeIn(),b.removeAttr("disabled").fadeIn(),u.removeAttr("disabled").fadeIn(),w.removeAttr("disabled").fadeIn(),k.removeAttr("disabled").fadeIn()}h.on("click",re),c.on("click",re),f.on("click",function(e){ae-=10,ve(te-=10,ie,!1),ve(ae,oe,!0),be(),ue()}),v.on("click",function(e){ae+=10,ve(te+=10,ie,!1),ve(ae,oe,!0),be(),ue()}),b.on("click",function(e){oe-=10,ve(te,ie-=10,!1),ve(ae,oe,!0),be(),ue()}),u.on("click",function(e){oe+=10,ve(te,ie+=10,!1),ve(ae,oe,!0),be(),ue()}),w.on("click",function(a){oe=ie+e*((ae+=10)-te)/t,ve(te,ie,!1),ve(ae,oe,!0),be(),ue()}),k.on("click",function(a){oe=ie+e*((ae-=10)-te)/t,ve(te,ie,!1),ve(ae,oe,!0),be(),ue()}),p.on("click",function(e){a.text(J[1]),ue(),x.clearRect(0,0,y.width,y.height),!0,m.hide(),f.hide(),v.hide(),b.hide(),u.hide(),w.hide(),k.hide(),c.removeAttr("disabled").fadeIn()}),m.on("click",function(){if(a.text(J[3]),p.hide(),m.hide(),f.hide(),v.hide(),b.hide(),u.hide(),w.hide(),k.hide(),g.removeAttr("disabled").fadeIn(),pe>ge){var i=pe;pe=ge,ge=i}if(me>fe){i=me;me=fe,fe=i}R=I.getImageData(pe,me,ge-pe,fe-me),T.width=ge-pe,T.height=fe-me,S.putImageData(R,0,0),D.width=t,D.height=e;var o=new Image;o.onload=function(){L.drawImage(o,0,0,t,e)},o.src=T.toDataURL(),j.remove(),P.addClass("col-6"),U.remove(),r.show(),d.show(),O=!0});var de=$("#fileInput"),se=$("#allCanvas");g.on("click",function(){if(B||E)if(E){var e="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><p class='mb-1'><div class='alert alert-primary' role='alert'>Right click on the image, select 'Save picture as' to save.</p></div> <div class='text-center'><img src='"+M[0].toDataURL("image/jpeg",1)+"' alt='from canvas'/></div></div></body></html>";(t=window.open()).document.write(e),t?t.focus():alert("Please allow popups for this website")}else{var t;e="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><div class='text-center'><img src='"+M[0].toDataURL("image/jpeg",1)+"' alt='from canvas'/></div><p class='mb-1'><div class='alert alert-danger' role='alert'>Tap and hold on the image. Select the Save Image button to save. </div></p></div></body></html>";(t=window.open()).document.write(e),t?t.focus():alert("Please allow popups for this website")}else{var i=document.createElement("a");i.style="position: fixed; left -10000px;",i.href="data:application/octet-stream;base64,"+encodeURIComponent(M[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),i.download=""==r.val()?"T1111111Z.jpg":r.val()+".jpg",document.body.appendChild(i),i.click(),document.body.removeChild(i),a.html("<div class='alert alert-primary' role='alert'>Saved.</div>"),g.hide(),de.hide(),se.hide()}});var le=new Array,he=new Array,ce=new Array,pe=0,me=0,ge=0,fe=0,ve=function(e,t,a){le.push(e),he.push(t),ce.push(a)},be=function(){x.strokeStyle="#df4b26",x.lineJoin="butt",x.lineWidth=Y,le.length>0&&(x.clearRect(0,0,y.width,y.height),pe=le[0],me=he[0],ge=le[le.length-1],fe=he[he.length-1],pe<ge&&me<fe?(Math.abs(ge-pe)/Math.abs(fe-me)<t/e?fe=e/t*(ge-pe)+me:ge=t/e*(fe-me)+pe,x.strokeRect(pe,me,Math.abs(ge-pe),Math.abs(fe-me))):pe>ge&&me<fe?(Math.abs(ge-pe)/Math.abs(fe-me)<t/e?fe=e/t*(pe-ge)+me:ge=pe-t/e*(fe-me),x.strokeRect(ge,me,Math.abs(ge-pe),Math.abs(fe-me))):pe<ge&&me>fe?(Math.abs(ge-pe)/Math.abs(fe-me)<t/e?fe=e/t*(ge-pe)+me:ge=t/e*(me-fe)+pe,x.strokeRect(pe,fe,Math.abs(ge-pe),Math.abs(fe-me))):(Math.abs(ge-pe)/Math.abs(fe-me)<t/e?fe=e/t*(pe-ge)+me:ge=pe-t/e*(me-fe),x.strokeRect(ge,fe,Math.abs(ge-pe),Math.abs(fe-me))),p.removeAttr("disabled").fadeIn(),m.removeAttr("disabled").fadeIn(),s.hide(),l.hide())},ue=function(){le.length=0,he.length=0,ce.length=0,!1}});</script>
    </body>
</html>