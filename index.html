<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading, Auto Facial Detection and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>

    <!-- https://github.com/jaysalvat/jquery.facedetection JavaScript -->
    <script src="jquery.facedetection.min.js"></script>  
    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        
        @media only screen and (min-width: 500px) { 
            canvas {
                width: 400px;
                height: auto;
            }

            #gettingstarted {
                width: 500px;
                height: auto;
            }
        }


        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <div class="sticky-top">
        <button class="btn btn-primary" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary" id="btnFlip" disabled>Flip selfie</button>

        <button class="btn btn-primary" id="btnClearrect" disabled>Clear</button>
        <button class="btn btn-primary" id="btnReady" disabled>Ready</button>
        <button class="btn btn-primary" id="btnAuto" disabled>Automatic</button>
        <button class="btn btn-primary" id="btnCrop" disabled>Crop</button>
        <button class="btn btn-primary" id="btnSave" disabled>Save photo</button>
        <button class="btn btn-secondary" id="btnLeft" disabled>Left</button>
        <button class="btn btn-secondary" id="btnRight" disabled>Right</button>
        <button class="btn btn-secondary" id="btnUp" disabled>Up</button>
        <button class="btn btn-secondary" id="btnDown" disabled>Down</button>
        <button class="btn btn-secondary" id="btnBig" disabled>Bigger</button>
        <button class="btn btn-secondary" id="btnSmall" disabled>Smaller</button>
    </div>
    
    <p id="hints" class="mb-1 lead">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC Eg T1234567Z" aria-label="Name eg anything" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>


    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>


</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
    <script type="text/javascript">$(document).ready(function(){var e=320,t=240,a=$("#hints"),i=$("#alert1"),o=$("#alert2"),n=$("#fileTocrop"),r=$("#fileTosave"),d=$("#labelTosave"),s=$("#btnRotate"),l=$("#btnFlip"),h=$("#btnReady"),c=$("#btnAuto"),p=$("#btnClearrect"),m=$("#btnCrop"),g=$("#btnSave"),u=$("#btnLeft"),f=$("#btnRight"),v=$("#btnUp"),b=$("#btnDown"),w=$("#btnBig"),k=$("#btnSmall"),C=$("#myCanvas"),y=C[0],x=y.getContext("2d"),I=$("#myCanvasTop"),A=I[0],R=A.getContext("2d");R.globalAlpha=.2;var M,D=$("#myCropcanvas"),T=D[0],L=T.getContext("2d"),S=$("#myTempcanvas")[0],j=S.getContext("2d"),P=($("#picture"),$("#col2")),U=$("#col3"),X=$("#col4"),Y=!1,B=!1,O=1,E=!1,F=/ipad|iphone|ipod/i.test(navigator.userAgent.toLowerCase()),z=/msie|trident|edge/i.test(navigator.userAgent.toLowerCase()),J=/crios/i.test(navigator.userAgent.toLowerCase()),W=/webkit/i.test(navigator.userAgent.toLowerCase()),Z=["Rotate/Flip photo if necessary.  Click 'Ready' to start cropping","Tap, hold and drag on the photo to draw a rectangle area to crop it to size. Click 'Automatic' to generate the rectangle","Click on ‘Clear’ to start again.  Click ‘Crop’ if you are satisfied with it.  Click Left/ Right/ Up/ Down/ Bigger/ Smaller to adjust the rectangle","Type in the filename to save as and click ‘Save photo’","Select a photo from your device to crop","Only Safari browser is supported on iPhones/iPads.  Your browser is not supported!","Only Chrome browser is supported on Desktop computers/Laptops.  Your browser is not supported!"];F&&W&&J?a.html("<div class='alert alert-danger' role='alert'>"+Z[5]+"</div>"):z?a.html("<div class='alert alert-danger' role='alert'>"+Z[6]+"</div>"):a.text(Z[4]);var q,G;q=y.getBoundingClientRect(),G=window.devicePixelRatio,y.width=Math.round(G*q.right)-Math.round(G*q.left),y.height=Math.round(G*q.bottom)-Math.round(G*q.top),x.scale(G,G),r.hide(),d.hide(),C.hide(),s.hide(),l.hide(),h.hide(),c.hide(),p.hide(),m.hide(),g.hide(),u.hide(),f.hide(),v.hide(),b.hide(),w.hide(),k.hide();var H,K,N=new Image;n.on("change",function(e){a.text(Z[0]),i.hide(),o.hide();var t=new FileReader;t.onload=function(e){N.onload=function(){H=N.width,K=N.height,H>K?H>480&&(K*=480/H,H=480):K>640&&(H*=640/K,K=640),A.width=y.width=H,A.height=y.height=K,x.drawImage(N,0,0,H,K),O=Math.round(5/480*H)},N.src=e.target.result},t.readAsDataURL(e.target.files[0]),C.fadeIn(),P.addClass("col-12"),s.removeAttr("disabled").fadeIn(),l.removeAttr("disabled").fadeIn(),h.removeAttr("disabled").fadeIn(),n.hide(),Y=!0,B=!0});var Q=1,V=!1;s.on("click",function(e){a.text(Z[0]),V=!0,te(),Q++,V=!1,Y=!0});var _=1,ee=!1;l.on("click",function(e){a.text(Z[0]),ee=!0,te(),_++,ee=!1,Y=!0});var te=function(){x.clearRect(0,0,y.width,y.height);var e=V?Q:Q-1;e%2==0?(A.width=y.width=H,A.height=y.height=K):(A.width=y.width=K,A.height=y.height=H),x.save(),e%2==0?x.translate(H/2,K/2):x.translate(K/2,H/2),x.rotate(90*e*Math.PI/180),x.translate(-H/2,-K/2),(ee?_:_-1)%2==0||(e%2==0?(x.translate(H,0),x.scale(-1,1)):(x.translate(0,K),x.scale(1,-1))),x.drawImage(N,0,0,H,K),x.restore()},ae="";$(window).on("scroll",function(e){ae=a.html(),!E&&B&&p.trigger("click"),a.html(ae)}),$(window).on("resize",function(e){ae=a.html(),!E&&B&&p.trigger("click"),a.html(ae)});var ie,oe,ne,re,de=!1;function se(i){a.text(Z[2]),C.faceDetection({complete:function(a){console.log(a),1!=a.length?de=!0:(ie=a[0].x-((a[0].offsetX+a[0].width)*a[0].scaleX-a[0].x)/3,oe=(a[0].offsetX+a[0].width)*a[0].scaleX+((a[0].offsetX+a[0].width)*a[0].scaleX-a[0].x)/5,ie<0&&(ie=0),oe>240&&(oe=240),(ne=a[0].y-(a[0].offsetY+a[0].height)*a[0].scaleY/4)<0&&(ne=0),re=ne+e*(oe-ie)/t,$e(ie,ne,!1),$e(oe,re,!0),ye(),xe())},error:function(e,t){de=!0}}),de&&(oe=190,re=240,$e(ie=70,ne=80,!1),$e(oe,re,!0),ye(),xe()),Y=!1,s.hide(),l.hide(),h.hide(),u.removeAttr("disabled").fadeIn(),f.removeAttr("disabled").fadeIn(),v.removeAttr("disabled").fadeIn(),b.removeAttr("disabled").fadeIn(),w.removeAttr("disabled").fadeIn(),k.removeAttr("disabled").fadeIn()}h.on("click",se),c.on("click",se),u.on("click",function(e){oe-=10,$e(ie-=10,ne,!1),$e(oe,re,!0),ye(),xe()}),f.on("click",function(e){oe+=10,$e(ie+=10,ne,!1),$e(oe,re,!0),ye(),xe()}),v.on("click",function(e){re-=10,$e(ie,ne-=10,!1),$e(oe,re,!0),ye(),xe()}),b.on("click",function(e){re+=10,$e(ie,ne+=10,!1),$e(oe,re,!0),ye(),xe()}),w.on("click",function(a){re=ne+e*((oe+=10)-ie)/t,$e(ie,ne,!1),$e(oe,re,!0),ye(),xe()}),k.on("click",function(a){re=ne+e*((oe-=10)-ie)/t,$e(ie,ne,!1),$e(oe,re,!0),ye(),xe()}),p.on("click",function(e){a.text(Z[1]),xe(),R.clearRect(0,0,y.width,y.height),Y=!0,m.hide(),u.hide(),f.hide(),v.hide(),b.hide(),w.hide(),k.hide(),c.removeAttr("disabled").fadeIn()}),m.on("click",function(){if(a.text(Z[3]),p.hide(),m.hide(),u.hide(),f.hide(),v.hide(),b.hide(),w.hide(),k.hide(),g.removeAttr("disabled").fadeIn(),fe>be){var i=fe;fe=be,be=i}if(ve>we){i=ve;ve=we,we=i}M=x.getImageData(fe,ve,be-fe,we-ve),S.width=be-fe,S.height=we-ve,j.putImageData(M,0,0),T.width=t,T.height=e;var o=new Image;o.onload=function(){L.drawImage(o,0,0,t,e)},o.src=S.toDataURL(),P.remove(),U.addClass("col-6"),X.remove(),r.show(),d.show(),E=!0});var le=$("#fileInput"),he=$("#allCanvas");g.on("click",function(){if(F||z)if(z){var e="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><p class='mb-1'><div class='alert alert-primary' role='alert'>Right click on the image, select 'Save picture as' to save.</p></div> <div class='text-center'><img src='"+D[0].toDataURL("image/jpeg",1)+"' alt='from canvas'/></div></div></body></html>";(t=window.open()).document.write(e),t?t.focus():alert("Please allow popups for this website")}else{var t;e="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><div class='text-center'><img src='"+D[0].toDataURL("image/jpeg",1)+"' alt='from canvas'/></div><p class='mb-1'><div class='alert alert-danger' role='alert'>Tap and hold on the image. Select the Save Image button to save. </div></p></div></body></html>";(t=window.open()).document.write(e),t?t.focus():alert("Please allow popups for this website")}else{var i=document.createElement("a");i.style="position: fixed; left -10000px;",i.href="data:application/octet-stream;base64,"+encodeURIComponent(D[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),i.download=""==r.val()?"T1111111Z.jpg":r.val()+".jpg",document.body.appendChild(i),i.click(),document.body.removeChild(i),a.html("<div class='alert alert-primary' role='alert'>Saved.</div>"),g.hide(),le.hide(),he.hide()}}),I.on("mousedown touchstart",function(e){B&&!E&&(Y||(u.hide(),f.hide(),v.hide(),b.hide(),w.hide(),k.hide(),p.trigger("click")),ke=!0,Ce(e),$e(ce,pe,!1))}),I.on("mousemove touchmove",function(e){ke&&!E&&(Ce(e),$e(ce,pe,!0),ye())}),I.on("mouseup touchend",function(){ke&&!E&&(a.text(Z[2]),ye(),xe(),Y=!1)}),I.on("mouseleave touchcancel",function(){ke&&!E&&(a.text(Z[2]),ye(),xe(),Y=!1)});var ce=0,pe=0,me=new Array,ge=new Array,ue=new Array,fe=0,ve=0,be=0,we=0,ke=!1,Ce=function(e){var t=y.getBoundingClientRect(),a=y.width/t.width,i=y.height/t.height;e.touches?(ce=(e.touches[0].pageX-t.left)*a,pe=(e.touches[0].pageY-t.top)*i,e.preventDefault()):(ce=(e.clientX-t.left)*a,pe=(e.clientY-t.top)*i)},$e=function(e,t,a){me.push(e),ge.push(t),ue.push(a)},ye=function(){R.strokeStyle="#df4b26",R.lineJoin="butt",R.lineWidth=O,me.length>0&&(R.clearRect(0,0,y.width,y.height),fe=me[0],ve=ge[0],be=me[me.length-1],we=ge[ge.length-1],fe<be&&ve<we?(Math.abs(be-fe)/Math.abs(we-ve)<t/e?we=e/t*(be-fe)+ve:be=t/e*(we-ve)+fe,R.strokeRect(fe,ve,Math.abs(be-fe),Math.abs(we-ve))):fe>be&&ve<we?(Math.abs(be-fe)/Math.abs(we-ve)<t/e?we=e/t*(fe-be)+ve:be=fe-t/e*(we-ve),R.strokeRect(be,ve,Math.abs(be-fe),Math.abs(we-ve))):fe<be&&ve>we?(Math.abs(be-fe)/Math.abs(we-ve)<t/e?we=e/t*(be-fe)+ve:be=t/e*(ve-we)+fe,R.strokeRect(fe,we,Math.abs(be-fe),Math.abs(we-ve))):(Math.abs(be-fe)/Math.abs(we-ve)<t/e?we=e/t*(fe-be)+ve:be=fe-t/e*(ve-we),R.strokeRect(be,we,Math.abs(be-fe),Math.abs(we-ve))),p.removeAttr("disabled").fadeIn(),m.removeAttr("disabled").fadeIn(),s.hide(),l.hide())},xe=function(){me.length=0,ge.length=0,ue.length=0,ke=!1}});</script>
    </body>
</html>