<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading, Auto Facial Detection and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>

    <!-- https://github.com/jaysalvat/jquery.facedetection JavaScript -->
    <script src="jquery.facedetection.min.js"></script>  
    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        
        @media only screen and (min-width: 500px) { 
            canvas {
                width: 400px;
                height: auto;
            }

            #gettingstarted {
                width: 500px;
                height: auto;
            }
        }


        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <div class="sticky-top">
        <button class="btn btn-primary" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary" id="btnFlip" disabled>Flip selfie</button>

        <button class="btn btn-primary" id="btnClearrect" disabled>Clear</button>
        <button class="btn btn-primary" id="btnReady" disabled>Ready</button>
        <button class="btn btn-primary" id="btnCrop" disabled>Crop</button>
        <button class="btn btn-primary" id="btnSave" disabled>Save photo</button>
        <button class="btn btn-secondary" id="btnLeft" disabled>Left</button>
        <button class="btn btn-secondary" id="btnRight" disabled>Right</button>
        <button class="btn btn-secondary" id="btnUp" disabled>Up</button>
        <button class="btn btn-secondary" id="btnDown" disabled>Down</button>
        <button class="btn btn-secondary" id="btnBig" disabled>Bigger</button>
        <button class="btn btn-secondary" id="btnSmall" disabled>Smaller</button>
    </div>
    
    <p id="hints" class="mb-1 lead">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC Eg T1234567Z" aria-label="Name eg anything" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>


    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>


</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
    <script type="text/javascript">$(document).ready(function(){var e=$("#hints"),t=$("#alert1"),a=$("#alert2"),i=$("#fileTocrop"),o=$("#fileTosave"),n=$("#labelTosave"),r=$("#btnRotate"),d=$("#btnFlip"),s=$("#btnReady"),l=$("#btnClearrect"),h=$("#btnCrop"),c=$("#btnSave"),p=$("#btnLeft"),m=$("#btnRight"),g=$("#btnUp"),f=$("#btnDown"),u=$("#btnBig"),v=$("#btnSmall"),b=$("#myCanvas"),w=b[0],C=w.getContext("2d"),k=$("#myCanvasTop"),y=k[0],x=y.getContext("2d");x.globalAlpha=.2;var I,R=$("#myCropcanvas"),M=R[0],A=M.getContext("2d"),D=$("#myTempcanvas")[0],T=D.getContext("2d"),L=($("#picture"),$("#col2")),S=$("#col3"),j=$("#col4"),P=!1,U=!1,X=1,Y=!1,B=/ipad|iphone|ipod/i.test(navigator.userAgent.toLowerCase()),O=/msie|trident|edge/i.test(navigator.userAgent.toLowerCase()),E=/crios/i.test(navigator.userAgent.toLowerCase()),F=/webkit/i.test(navigator.userAgent.toLowerCase()),z=["Rotate/Flip photo if necessary.  Click 'Ready' to start cropping","Tap, hold and drag on the photo to draw a rectangle area to crop it to size","Click on ‘Clear’ to start again.  Click ‘Crop’ if you are satisfied with it.  Click Left/ Right/ Up/ Down/ Bigger/ Smaller to adjust the rectangle","Type in the filename to save as and click ‘Save photo’","Select a photo from your device to crop","Only Safari browser is supported on iPhones/iPads.  Your browser is not supported!","Only Chrome browser is supported on Desktop computers/Laptops.  Your browser is not supported!"];B&&F&&E?e.html("<div class='alert alert-danger' role='alert'>"+z[5]+"</div>"):O?e.html("<div class='alert alert-danger' role='alert'>"+z[6]+"</div>"):e.text(z[4]);var J,W;J=w.getBoundingClientRect(),W=window.devicePixelRatio,w.width=Math.round(W*J.right)-Math.round(W*J.left),w.height=Math.round(W*J.bottom)-Math.round(W*J.top),C.scale(W,W),o.hide(),n.hide(),b.hide(),r.hide(),d.hide(),s.hide(),l.hide(),h.hide(),c.hide(),p.hide(),m.hide(),g.hide(),f.hide(),u.hide(),v.hide();var Z,q,G=new Image;i.on("change",function(o){e.text(z[0]),t.hide(),a.hide();var n=new FileReader;n.onload=function(e){G.onload=function(){Z=G.width,q=G.height,Z>q?Z>480&&(q*=480/Z,Z=480):q>640&&(Z*=640/q,q=640),y.width=w.width=Z,y.height=w.height=q,C.drawImage(G,0,0,Z,q),X=Math.round(5/480*Z)},G.src=e.target.result},n.readAsDataURL(o.target.files[0]),b.fadeIn(),L.addClass("col-12"),r.removeAttr("disabled").fadeIn(),d.removeAttr("disabled").fadeIn(),s.removeAttr("disabled").fadeIn(),i.hide(),P=!0,U=!0});var H=1,K=!1;r.on("click",function(t){e.text(z[0]),K=!0,V(),H++,K=!1,P=!0});var N=1,Q=!1;d.on("click",function(t){e.text(z[0]),Q=!0,V(),N++,Q=!1,P=!0});var V=function(){C.clearRect(0,0,w.width,w.height);var e=K?H:H-1;e%2==0?(y.width=w.width=Z,y.height=w.height=q):(y.width=w.width=q,y.height=w.height=Z),C.save(),e%2==0?C.translate(Z/2,q/2):C.translate(q/2,Z/2),C.rotate(90*e*Math.PI/180),C.translate(-Z/2,-q/2),(Q?N:N-1)%2==0||(e%2==0?(C.translate(Z,0),C.scale(-1,1)):(C.translate(0,q),C.scale(1,-1))),C.drawImage(G,0,0,Z,q),C.restore()},_="";$(window).on("scroll",function(t){_=e.html(),!Y&&U&&l.trigger("click"),e.html(_)}),$(window).on("resize",function(t){_=e.html(),!Y&&U&&l.trigger("click"),e.html(_)});var ee,te,ae,ie,oe=!1;s.on("click",function(t){e.text(z[2]),b.faceDetection({complete:function(e){console.log(e),1!=e.length?oe=!0:(ee=e[0].x-((e[0].offsetX+e[0].width)*e[0].scaleX-e[0].x)/3,te=(e[0].offsetX+e[0].width)*e[0].scaleX+((e[0].offsetX+e[0].width)*e[0].scaleX-e[0].x)/5,ee<0&&(ee=0),te>240&&(te=240),(ae=e[0].y-(e[0].offsetY+e[0].height)*e[0].scaleY/4)<0&&(ae=0),ie=ae+320*(te-ee)/240,be(ee,ae,!1),be(te,ie,!0),we(),Ce())},error:function(e,t){oe=!0}}),oe&&(te=190,ie=240,be(ee=70,ae=80,!1),be(te,ie,!0),we(),Ce()),P=!1,r.hide(),d.hide(),s.hide(),p.removeAttr("disabled").fadeIn(),m.removeAttr("disabled").fadeIn(),g.removeAttr("disabled").fadeIn(),f.removeAttr("disabled").fadeIn(),u.removeAttr("disabled").fadeIn(),v.removeAttr("disabled").fadeIn()}),p.on("click",function(e){te-=10,be(ee-=10,ae,!1),be(te,ie,!0),we(),Ce()}),m.on("click",function(e){te+=10,be(ee+=10,ae,!1),be(te,ie,!0),we(),Ce()}),g.on("click",function(e){ie-=10,be(ee,ae-=10,!1),be(te,ie,!0),we(),Ce()}),f.on("click",function(e){ie+=10,be(ee,ae+=10,!1),be(te,ie,!0),we(),Ce()}),u.on("click",function(e){ie=ae+320*((te+=10)-ee)/240,be(ee,ae,!1),be(te,ie,!0),we(),Ce()}),v.on("click",function(e){ie=ae+320*((te-=10)-ee)/240,be(ee,ae,!1),be(te,ie,!0),we(),Ce()}),l.on("click",function(t){e.text(z[1]),Ce(),x.clearRect(0,0,w.width,w.height),P=!0,h.hide(),p.hide(),m.hide(),g.hide(),f.hide(),u.hide(),v.hide(),l.hide()}),h.on("click",function(){if(e.text(z[3]),l.hide(),h.hide(),p.hide(),m.hide(),g.hide(),f.hide(),u.hide(),v.hide(),c.removeAttr("disabled").fadeIn(),pe>ge){var t=pe;pe=ge,ge=t}if(me>fe){t=me;me=fe,fe=t}I=C.getImageData(pe,me,ge-pe,fe-me),D.width=ge-pe,D.height=fe-me,T.putImageData(I,0,0),M.width=240,M.height=320;var a=new Image;a.onload=function(){A.drawImage(a,0,0,240,320)},a.src=D.toDataURL(),L.remove(),S.addClass("col-6"),j.remove(),o.show(),n.show(),Y=!0});var ne=$("#fileInput"),re=$("#allCanvas");c.on("click",function(){if(B||O)if(O){var t="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><p class='mb-1'><div class='alert alert-primary' role='alert'>Right click on the image, select 'Save picture as' to save.</p></div> <div class='text-center'><img src='"+R[0].toDataURL("image/jpeg",1)+"' alt='from canvas'/></div></div></body></html>";(a=window.open()).document.write(t),a?a.focus():alert("Please allow popups for this website")}else{var a;t="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><div class='text-center'><img src='"+R[0].toDataURL("image/jpeg",1)+"' alt='from canvas'/></div><p class='mb-1'><div class='alert alert-danger' role='alert'>Tap and hold on the image. Select the Save Image button to save. </div></p></div></body></html>";(a=window.open()).document.write(t),a?a.focus():alert("Please allow popups for this website")}else{var i=document.createElement("a");i.style="position: fixed; left -10000px;",i.href="data:application/octet-stream;base64,"+encodeURIComponent(R[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),i.download=""==o.val()?"T1111111Z.jpg":o.val()+".jpg",document.body.appendChild(i),i.click(),document.body.removeChild(i),e.html("<div class='alert alert-primary' role='alert'>Saved.</div>"),c.hide(),ne.hide(),re.hide()}}),k.on("mousedown touchstart",function(e){U&&!Y&&(P||(p.hide(),m.hide(),g.hide(),f.hide(),u.hide(),v.hide(),l.trigger("click")),ue=!0,ve(e),be(de,se,!1))}),k.on("mousemove touchmove",function(e){ue&&!Y&&(ve(e),be(de,se,!0),we())}),k.on("mouseup touchend",function(){ue&&!Y&&(e.text(z[2]),we(),Ce(),P=!1)}),k.on("mouseleave touchcancel",function(){ue&&!Y&&(e.text(z[2]),we(),Ce(),P=!1)});var de=0,se=0,le=new Array,he=new Array,ce=new Array,pe=0,me=0,ge=0,fe=0,ue=!1,ve=function(e){var t=w.getBoundingClientRect(),a=w.width/t.width,i=w.height/t.height;e.touches?(de=(e.touches[0].pageX-t.left)*a,se=(e.touches[0].pageY-t.top)*i,e.preventDefault()):(de=(e.clientX-t.left)*a,se=(e.clientY-t.top)*i)},be=function(e,t,a){le.push(e),he.push(t),ce.push(a)},we=function(){x.strokeStyle="#df4b26",x.lineJoin="butt",x.lineWidth=X,le.length>0&&(x.clearRect(0,0,w.width,w.height),pe=le[0],me=he[0],ge=le[le.length-1],fe=he[he.length-1],pe<ge&&me<fe?(Math.abs(ge-pe)/Math.abs(fe-me)<.75?fe=320/240*(ge-pe)+me:ge=.75*(fe-me)+pe,x.strokeRect(pe,me,Math.abs(ge-pe),Math.abs(fe-me))):pe>ge&&me<fe?(Math.abs(ge-pe)/Math.abs(fe-me)<.75?fe=320/240*(pe-ge)+me:ge=pe-.75*(fe-me),x.strokeRect(ge,me,Math.abs(ge-pe),Math.abs(fe-me))):pe<ge&&me>fe?(Math.abs(ge-pe)/Math.abs(fe-me)<.75?fe=320/240*(ge-pe)+me:ge=.75*(me-fe)+pe,x.strokeRect(pe,fe,Math.abs(ge-pe),Math.abs(fe-me))):(Math.abs(ge-pe)/Math.abs(fe-me)<.75?fe=320/240*(pe-ge)+me:ge=pe-.75*(me-fe),x.strokeRect(ge,fe,Math.abs(ge-pe),Math.abs(fe-me))),l.removeAttr("disabled").fadeIn(),h.removeAttr("disabled").fadeIn(),r.hide(),d.hide())},Ce=function(){le.length=0,he.length=0,ce.length=0,ue=!1}});</script>
    </body>
</html>