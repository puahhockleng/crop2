<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>

    <!-- https://github.com/jaysalvat/jquery.facedetection JavaScript -->
    <script src="jquery.facedetection.min.js"></script>  
    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        
        @media only screen and (min-width: 500px) { 
            canvas {
                width: 400px;
                height: auto;
            }

            #gettingstarted {
                width: 500px;
                height: auto;
            }
        }


        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <div class="sticky-top">
        <button class="btn btn-primary" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary" id="btnFlip" disabled>Flip selfie</button>

        <button class="btn btn-primary" id="btnClearrect" disabled>Clear</button>
        <button class="btn btn-primary" id="btnReady" disabled>Ready</button>
        <button class="btn btn-primary" id="btnAuto" disabled>Automatic</button>
        <button class="btn btn-primary" id="btnCrop" disabled>Crop</button>
        <button class="btn btn-primary" id="btnSave" disabled>Save photo</button>
        <button class="btn btn-secondary" id="btnLeft" disabled>Left</button>
        <button class="btn btn-secondary" id="btnRight" disabled>Right</button>
        <button class="btn btn-secondary" id="btnUp" disabled>Up</button>
        <button class="btn btn-secondary" id="btnDown" disabled>Down</button>
        <button class="btn btn-secondary" id="btnBig" disabled>Bigger</button>
        <button class="btn btn-secondary" id="btnSmall" disabled>Smaller</button>
    </div>
    
    <p id="hints" class="mb-1 lead">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC Eg T1234567Z" aria-label="Name eg anything" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>


    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>


</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
    <script type="text/javascript">$(document).ready(function(){var e=320,t=240,a=$("#hints"),i=$("#alert1"),o=$("#alert2"),n=$("#fileTocrop"),r=$("#fileTosave"),d=$("#labelTosave"),s=$("#btnRotate"),l=$("#btnFlip"),h=$("#btnReady"),c=$("#btnAuto"),p=$("#btnClearrect"),m=$("#btnCrop"),g=$("#btnSave"),v=$("#btnLeft"),f=$("#btnRight"),b=$("#btnUp"),u=$("#btnDown"),w=$("#btnBig"),C=$("#btnSmall"),k=$("#myCanvas"),y=k[0],I=y.getContext("2d"),A=$("#myCanvasTop")[0],x=A.getContext("2d");x.globalAlpha=.2;var R,M=$("#myCropcanvas"),D=M[0],L=D.getContext("2d"),T=$("#myTempcanvas")[0],S=T.getContext("2d"),j=($("#picture"),$("#col2")),P=$("#col3"),U=$("#col4"),X=1,Y=/ipad|iphone|ipod/i.test(navigator.userAgent.toLowerCase()),O=/msie|trident|edge/i.test(navigator.userAgent.toLowerCase()),B=/crios/i.test(navigator.userAgent.toLowerCase()),E=/webkit/i.test(navigator.userAgent.toLowerCase()),F=["Rotate/Flip photo if necessary.  Click 'Ready' to start cropping","Click 'Automatic' to generate the rectangle","Click on ‘Clear’ to start again.  Click ‘Crop’ if you are satisfied with it.  Click Left/ Right/ Up/ Down/ Bigger/ Smaller to adjust the rectangle","Type in the filename to save as and click ‘Save photo’","Select a photo from your device to crop","Only Safari browser is supported on iPhones/iPads.  Your browser is not supported!","Only Chrome browser is supported on Desktop computers/Laptops.  Your browser is not supported!"];Y&&E&&B?a.html("<div class='alert alert-danger' role='alert'>"+F[5]+"</div>"):O?a.html("<div class='alert alert-danger' role='alert'>"+F[6]+"</div>"):a.text(F[4]);var J,W;J=y.getBoundingClientRect(),W=window.devicePixelRatio,y.width=Math.round(W*J.right)-Math.round(W*J.left),y.height=Math.round(W*J.bottom)-Math.round(W*J.top),I.scale(W,W),r.hide(),d.hide(),k.hide(),s.hide(),l.hide(),h.hide(),c.hide(),p.hide(),m.hide(),g.hide(),v.hide(),f.hide(),b.hide(),u.hide(),w.hide(),C.hide();var Z,q,z=new Image;n.on("change",function(e){a.text(F[0]),i.hide(),o.hide();var t=new FileReader;t.onload=function(e){z.onload=function(){Z=z.width,q=z.height,Z>q?Z>480&&(q*=480/Z,Z=480):q>640&&(Z*=640/q,q=640),A.width=y.width=Z,A.height=y.height=q,I.drawImage(z,0,0,Z,q),X=Math.round(5/480*Z)},z.src=e.target.result},t.readAsDataURL(e.target.files[0]),k.fadeIn(),j.addClass("col-12"),s.removeAttr("disabled").fadeIn(),l.removeAttr("disabled").fadeIn(),h.removeAttr("disabled").fadeIn(),n.hide(),!0,!0});var G=1,H=!1;s.on("click",function(e){a.text(F[0]),H=!0,te(),G++,H=!1,!0});var K=1,N=!1;l.on("click",function(e){a.text(F[0]),N=!0,te(),K++,N=!1,!0});var Q,V,_,ee,te=function(){I.clearRect(0,0,y.width,y.height);var e=H?G:G-1;e%2==0?(A.width=y.width=Z,A.height=y.height=q):(A.width=y.width=q,A.height=y.height=Z),I.save(),e%2==0?I.translate(Z/2,q/2):I.translate(q/2,Z/2),I.rotate(90*e*Math.PI/180),I.translate(-Z/2,-q/2),(N?K:K-1)%2==0||(e%2==0?(I.translate(Z,0),I.scale(-1,1)):(I.translate(0,q),I.scale(1,-1))),I.drawImage(z,0,0,Z,q),I.restore()},ae=!1;function ie(i){a.text(F[2]),k.faceDetection({complete:function(a){console.log(a),1!=a.length?ae=!0:(Q=a[0].x-((a[0].offsetX+a[0].width)*a[0].scaleX-a[0].x)/3,V=(a[0].offsetX+a[0].width)*a[0].scaleX+((a[0].offsetX+a[0].width)*a[0].scaleX-a[0].x)/5,Q<0&&(Q=0),V>240&&(V=240),(_=a[0].y-(a[0].offsetY+a[0].height)*a[0].scaleY/4)<0&&(_=0),ee=_+e*(V-Q)/t,me(Q,_,!1),me(V,ee,!0),ge(),ve())},error:function(e,t){ae=!0}}),ae&&(V=190,ee=240,me(Q=70,_=80,!1),me(V,ee,!0),ge(),ve()),!1,s.hide(),l.hide(),h.hide(),v.removeAttr("disabled").fadeIn(),f.removeAttr("disabled").fadeIn(),b.removeAttr("disabled").fadeIn(),u.removeAttr("disabled").fadeIn(),w.removeAttr("disabled").fadeIn(),C.removeAttr("disabled").fadeIn()}h.on("click",ie),c.on("click",ie),v.on("click",function(e){V-=10,me(Q-=10,_,!1),me(V,ee,!0),ge(),ve()}),f.on("click",function(e){V+=10,me(Q+=10,_,!1),me(V,ee,!0),ge(),ve()}),b.on("click",function(e){ee-=10,me(Q,_-=10,!1),me(V,ee,!0),ge(),ve()}),u.on("click",function(e){ee+=10,me(Q,_+=10,!1),me(V,ee,!0),ge(),ve()}),w.on("click",function(a){ee=_+e*((V+=10)-Q)/t,me(Q,_,!1),me(V,ee,!0),ge(),ve()}),C.on("click",function(a){ee=_+e*((V-=10)-Q)/t,me(Q,_,!1),me(V,ee,!0),ge(),ve()}),p.on("click",function(e){a.text(F[1]),ve(),x.clearRect(0,0,y.width,y.height),!0,m.hide(),v.hide(),f.hide(),b.hide(),u.hide(),w.hide(),C.hide(),c.removeAttr("disabled").fadeIn()}),m.on("click",function(){if(a.text(F[3]),p.hide(),m.hide(),v.hide(),f.hide(),b.hide(),u.hide(),w.hide(),C.hide(),g.removeAttr("disabled").fadeIn(),le>ce){var i=le;le=ce,ce=i}if(he>pe){i=he;he=pe,pe=i}R=I.getImageData(le,he,ce-le,pe-he),T.width=ce-le,T.height=pe-he,S.putImageData(R,0,0),D.width=t,D.height=e;var o=new Image;o.onload=function(){L.drawImage(o,0,0,t,e)},o.src=T.toDataURL(),j.remove(),P.addClass("col-6"),U.remove(),r.show(),d.show(),!0});var oe=$("#fileInput"),ne=$("#allCanvas");g.on("click",function(){if(Y||O)if(O){var e="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><p class='mb-1'><div class='alert alert-primary' role='alert'>Right click on the image, select 'Save picture as' to save.</p></div> <div class='text-center'><img src='"+M[0].toDataURL("image/jpeg",1)+"' alt='from canvas'/></div></div></body></html>";(t=window.open()).document.write(e),t?t.focus():alert("Please allow popups for this website")}else{var t;e="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><div class='text-center'><img src='"+M[0].toDataURL("image/jpeg",1)+"' alt='from canvas'/></div><p class='mb-1'><div class='alert alert-danger' role='alert'>Tap and hold on the image. Select the Save Image button to save. </div></p></div></body></html>";(t=window.open()).document.write(e),t?t.focus():alert("Please allow popups for this website")}else{var i=document.createElement("a");i.style="position: fixed; left -10000px;",i.href="data:application/octet-stream;base64,"+encodeURIComponent(M[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),i.download=""==r.val()?"T1111111Z.jpg":r.val()+".jpg",document.body.appendChild(i),i.click(),document.body.removeChild(i),a.html("<div class='alert alert-primary' role='alert'>Saved.</div>"),g.hide(),oe.hide(),ne.hide()}});var re=new Array,de=new Array,se=new Array,le=0,he=0,ce=0,pe=0,me=function(e,t,a){re.push(e),de.push(t),se.push(a)},ge=function(){x.strokeStyle="#df4b26",x.lineJoin="butt",x.lineWidth=X,re.length>0&&(x.clearRect(0,0,y.width,y.height),le=re[0],he=de[0],ce=re[re.length-1],pe=de[de.length-1],le<ce&&he<pe?(Math.abs(ce-le)/Math.abs(pe-he)<t/e?pe=e/t*(ce-le)+he:ce=t/e*(pe-he)+le,x.strokeRect(le,he,Math.abs(ce-le),Math.abs(pe-he))):le>ce&&he<pe?(Math.abs(ce-le)/Math.abs(pe-he)<t/e?pe=e/t*(le-ce)+he:ce=le-t/e*(pe-he),x.strokeRect(ce,he,Math.abs(ce-le),Math.abs(pe-he))):le<ce&&he>pe?(Math.abs(ce-le)/Math.abs(pe-he)<t/e?pe=e/t*(ce-le)+he:ce=t/e*(he-pe)+le,x.strokeRect(le,pe,Math.abs(ce-le),Math.abs(pe-he))):(Math.abs(ce-le)/Math.abs(pe-he)<t/e?pe=e/t*(le-ce)+he:ce=le-t/e*(he-pe),x.strokeRect(ce,pe,Math.abs(ce-le),Math.abs(pe-he))),p.removeAttr("disabled").fadeIn(),m.removeAttr("disabled").fadeIn(),s.hide(),l.hide())},ve=function(){re.length=0,de.length=0,se.length=0,!1}});</script>
    </body>
</html>